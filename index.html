<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    
    <script type="text/javascript" src="./lib/d3.v3.js"></script>
    <script type="text/javascript" src="./lib/topojson.js"></script>
    <script type="text/javascript" src="./lib/jquery.js"></script>
    <script type="text/javascript" src="./lib/jquery-ui.js"></script>
    <script type="text/javascript" src="./lib/crossfilter.v1.js"></script>
    <script type="text/javascript" src="./lib/sankey.js"></script>
    
    <link type="text/css" rel="stylesheet" href="./style/jquery-ui.css" />
    <title>A study in toxic releases</title>
    <style type="text/css">
        #container
        {
            margin: auto;
            width: 760px;
            background: #ffffff;
        }
        
        #header
        {
            background: #DDDDDD;
            text-align: right;
        }
        #search-header
        {
            background: #DDDDDD;
        }
        
        #leftBar
        {
            position: relative;
            float: left;
            width: 355px;
            background: #EBEBEB;
            height: 250px;
            text-align: right;
            border: 1px solid #000;
            -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
            -moz-box-sizing: border-box;    /* Firefox, other Gecko */
            box-sizing: border-box;         /* Opera/IE 8+ */

        }
        #leftBar p {
            position: absolute;
            bottom: 0;
            right:0px;
        }
        
        #content
        {
            float: left;
            width: 756px;
            background-color: #cdcde6;
            height: 259px;
        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
        #rightBar
        {
            position:relative;
            float: right;
            width: 394px;
            background: #EBEBEB;
            height: 250px;
            text-align: right;
            border: 1px solid #000;
            -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
            -moz-box-sizing: border-box;    /* Firefox, other Gecko */
            box-sizing: border-box;         /* Opera/IE 8+ */
        }
        #rightBar p {
            position: absolute;
            bottom: 0;
            right:0px;
        }
        #sub-footer
        {
            position:relative;
            clear: both;
            background: #DDDDDD;
            height: 155px;
        }
        #sub-footer p {
            position: absolute;
            bottom: 0;
            right:0px;
        }

        #footer
        {
            position:relative;
            clear: both;
            background: #DDDDDD;
            height: 75px;
        }

        /* for text elements over the circles */
        #footer text {
            font: 15px sans-serif;
            /*pointer-events: none;*/
            cursor: pointer;
        }
        
        #footer y {
            position:absolute;
            right:0px;
            top: 0;
        }
        #footer r {
            position: absolute;
            left:0px;
            top: 0;
        }
        #help {
            height:500px;
            width:500px;
            font: 15px serif;
        }
        #help text {
            font: 15px serif;
        }
        .hidden
        {
            display:none;
        }
        /* sankey */
        .node rect {
            cursor: move;
            fill-opacity: .9;
            shape-rendering: crispEdges;
        }
 
        .node text {
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
        }
 
        .link {
            fill: none;
            stroke: #000;
            stroke-opacity: .2;
        }
 
 
        .cycleLink {
            fill: none;
            stroke: #300;
            stroke-opacity: .2;
        }
 
        .cycleLink:hover {
            stroke-opacity: .5;
        }
 
        .link:hover {
            stroke-opacity: .5;
        }

        /* sunburst */
        path {
            stroke: #fff;
            fill-rule: evenodd;
        }
        path:hover {
            stroke-opacity: .5;
        }
        
        /* brush */
        .brush .extent {
            fill-opacity: .3;
            stroke: #fff;
            shape-rendering: crispEdges;
        }
                
        /* header text for each section */
        .heading {
            cursor: pointer;
            text-anchor: middle;
            font-size: 15pt;
            text-decoration: underline;
            fill:blue;

        }
        .filterText {
            cursor: hand;
            text-anchor: end;
            font-size: 10pt;
            text-align: right;
        }

        /* progressbar for making the user wait */
        #progressbarDlg {
            height:20px;
            width:70px;
            font: 15px serif;

        }
        #progressbar .ui-progressbar-value {
            background-color: #ccc;
        }
        .ui-progressbar {
            position: relative;
        }
        .progress-label {
            position: absolute;
            left: 40%;
            top: 0px;
            font-size: 10pt;
            text-align: middle;
        }
        
        .no-close-button .ui-dialog-titlebar-close {
            display: none;
        }
        .no-title-bar .ui-dialog-title {
            display: none;
        }
        
        /* for counties */
        .counties {
            fill: none;
        }
        .counties path hover {
            fill:red;
        }
        
        .states {
            fill: none;
            stroke: #fff;
            stroke-linejoin: round;
        }
        
        .GnYlRd .q11-11 { fill:#BBBBBB; } /* display for nulls,nan,undefined etc*/
        .GnYlRd .q10-11{fill:rgb(165,0,38)}
        .GnYlRd .q9-11{fill:rgb(215,48,39)}
        .GnYlRd .q8-11{fill:rgb(244,109,67)}
        .RdYlGn .q7-11{fill:rgb(253,174,97)}
        .GnYlRd .q6-11{fill:rgb(254,224,139)}
        .GnYlRd .q5-11{fill:rgb(255,255,191)}
        .GnYlRd .q4-11{fill:rgb(217,239,139)}
        .GnYlRd .q3-11{fill:rgb(166,217,106)}
        .GnYlRd .q2-11{fill:rgb(102,189,99)}
        .GnYlRd .q1-11{fill:rgb(26,152,80)}
        .GnYlRd .q0-11{fill:rgb(0,104,55)}
        
        /* drop down */

        </style>
    <h2 align="center">A study in toxic releases</h2>
</head>
<body>

    <div id="container">
        <div id="help" class="hidden" title="Help">Help test!</div>
        <div id="progressbarDlg" class="hidden"><div id="progressbar"><div id="progressLbl" class="progress-label">Please wait...</div></div></div>
        
        <div id="intro">
            This is an attempt to visually simplify and integrate, twenty years of data from the <a href="http://www.epa.gov/tri/triprogram/whatis.htm">Toxic Release Inventory</a> program. This represention can be used to slice and dice the data to answer questions of interest. Some questions are total amount of pollutants being released ? Which chemical is released at which facility and how much? How much is treated, or recycled? Is it being released into water, air, land etc ?
        </div>
    
        <!-- -->
        <div id="footer"><r id="captionResetAllFilters"><a href="javascript:resetAllFilters(true)">Reset All Filters</a></r><y id="yearFilterText">Current Year:1987</y></div>
        
        <!-- -->
        <div id="search">
            <label for="tags">Search for State, Chemicals or Facilities (Type three letters ...) </label>
            <input id="tags" style="width:340px">
        </div>
        
        <!-- -->
        <div id="sub-footer">
            <p id="mediumFilter">
                <a id="link" title="Reset Filter" href="javascript:resetFilter(null,null,null,1)">Filter:</a>
                <text id="mediumFilterText">None</text>
            </p>
        </div>
        
        <!-- -->
        <div id="content">
            <div id="leftBar">
                <p id="mapFilter">
                    <a id="link" title="Reset Filter" href="javascript:resetFilter(1,null,null,null)">Filter:</a>
                    <text id="mapFilterText">None</text>
                </p>
            </div>
            <div id="rightBar">
                <p id="sunburstFilter">
                    <a id="sunburstFilterLink" title="Reset Filter" href="javascript:resetFilter(null,1,null,null)">Filter:</a>
                    <text id="sunburstFilterText">None</text>
                </p>
            </div>
        </div>
        <!-- -->
        <div id="ack">
            <br/>Acknowledgements: This work is based upon the splendid examples of d3 by <a href="http://bost.ocks.org/mike/">Mike Bostock</a>. The color selection by <a href="http://www.personal.psu.edu/users/c/a/cab38/">Cynthia Brewer</a>. The speed of the data filter is attributed to <a href="http://square.github.io/crossfilter/">CrossFilter</a>. The data is from the open data <a href="http://www.data.gov">site</a>.
        </div>
    </div>

    <script type="text/javascript">
        
        function showHelp(whom){
            var helpText = "";
            if(whom===0){ // the years
                helpText = helpText + "Clicking on a year loads the toxic release data for that year. Filters applied will be lost.";
                helpText = helpText + "Hover over the circle to show more details of the release for that year.";
            }
            if(whom===1){ // medium release
                helpText = helpText + "Chemicals are the by-products of any modern industrial process and can be released into the environment through different ways.";
                helpText = helpText + "This graphic tries to capture the different mediums into which chemicals are released, both offsite and onsite.";
                helpText = helpText + "<br/>Air: Chemicals released through the air medium. Chimneys, or dispersion as a result of handling.";
                helpText = helpText + "<br/>Water: Chemicals released through the water medium. Water treatment plants.";
                helpText = helpText + "<br/>Landfills: Chemicals that are deemed safe to be sent off to landfills.";
                helpText = helpText + "<br/>Surface: Chemicals that are released either on surface of water or land in the form of leaks or spills.";
                helpText = helpText + "<br/>Underground: Chemicals that are injected into underground wells.";
                helpText = helpText + "<br/>Land treatment: Chemicals that are applied to or incorporated into soil.";
                helpText = helpText + "<br/>Recycle: Chemicals that are retrieved back from the waste and reused.";
                helpText = helpText + "<br/>Recovery: Chemicals that left the site for energy recovery as they have a combustible value.";
                helpText = helpText + "<br/>Treatment: Chemicals that are treated before releasing. An example of waste water plants.";
                helpText = helpText + "<br/>The amount of chemicals are represented in the size and color of the rectangular node.</br>";
                helpText = helpText + "Hover around the node to get more information.";
                helpText = helpText + "Click the gray links to apply it as a filter.";
                
            }
            if(whom===2){ // states
                helpText = helpText + "This spatial graphic shows the distribution of the chemicals over the United States.";
                helpText = helpText + "The color is corelated to the weight of the chemicals released.<br/>";
                helpText = helpText + "Gray color is used to represent unavailable data";
                helpText = helpText + "Hover over the state to get more information.";
                helpText = helpText + "On clicking the state, a filter is applied to the current dataset, with the respective state.";
                
            }
            
            if(whom===3){
                helpText = helpText + "This graphic is called a sunburst, and shows relations between chemicals and facilities.";
                helpText = helpText + "The inner ring shows the chemicals stacked in order of the weight of the releases.";
                helpText = helpText + "The outer ring corresponds to the chemicals and shows the facility where that particular";
                helpText = helpText + "chemical was released. So they are both dependant on one other.<br/>";
                helpText = helpText + "To search for chemicals or facilities textually, use the search textbox in the top of the screen.";
                helpText = helpText + "Hover over the elements, to get more information.";
                helpText = helpText + "Click on the element to apply it as a filter";

            }
            helpText = helpText + "To remove a filter, click on the Filter link";
            
            helpText = helpText + "All amount units are abbreviated:";
            helpText = helpText + "<ul>nGlbs = nGiga pounds = n X 1,000,000,000 pounds</ul>";
            helpText = helpText + "<ul>nMlbs = nMega pounds = n X 1,000,000 pounds.</ul>";
            helpText = helpText + "<ul>nKlbs = nKilo pounds = n X 1,000 pounds.</ul></br>";
            
            $("#help").html(helpText);
            $("#help").removeClass("hidden");
            $("#help").dialog({modal:false, height:400, width:700});
            //$("#help").addClass("hidden");
            
        }
        // readable values for long numbers
        function humanReadable(bytes) {
            var s = ['lbs', 'Klbs', 'Mlbs', 'Glbs', 'Tlbs', 'Plbs'];
            var e = bytes=== 0 ? 0 : Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, Math.floor(e))).toFixed(2) + " " + s[e];
        }
        // calculate the text metrics for the heading title
        function calcDummyTitle(text, className) {
            if(!text || text.length===0){
                return {height:0, width:0};
            }
            var container = d3.select("body").append("svg").attr("class", className);
            container.append("text").attr({x:-1000, y:-1000}).text(text);
            var bbox = container.node().getBBox();
            container.remove();
            
            return {height: bbox.height, width:bbox.width};
        }
        ////////////////////////////////////////////////////


//-- LEGEND --
//-- carcinogen : c
//-- Total releases : t
//-- Air releases : a
//-- water releases : w
//-- ground releases : g
//-- Land fills : f
//-- Land treatment : r
//-- Surface impoundment : u
//-- Chemical : h
//-- state : s
//-- Facility : y
//-- recovery : v
//-- recycle : e
//-- treatment : m

        var lkpSt = null;
        var lkpChm = null;
        var lkpFcy = null;
        var lkpUS = null;
        var formatPerc = d3.format(".00%");
        
        function initLkps() {
            
            if(lkpSt === null){
            
                var remaining = 4;
                //showProgress();
                
                d3.json("./data/lkpFcy.json", function (fcy) {
                       lkpFcy = fcy;
                       if (!--remaining)
                            initSearchBox();
                            //hideProgress();
                            main(null);
                       });
                
                d3.json("./data/lkpChm.json", function (chm) {
                        lkpChm = chm;
                        if (!--remaining)
                            initSearchBox();
                            //hideProgress();
                            main(null);
                        });
                
                d3.json("./data/lkpCounties.json", function (st) {
                        lkpSt = st;
                        if (!--remaining)
                            initSearchBox();
                            //hideProgress();
                            main(null);
                        });

                
                d3.json("./data/us.json", function (us) {
                        lkpUS = us;
                        if (!--remaining)
                            initSearchBox();
                            //hideProgress();
                            main(null);
                        });
            }
        }

        function initSearchBox(){

            var lkpSrch = [];
            lkpSt.forEach(function(d){lkpSrch.push({value:d.f, label:d.c + "," + d.s, typ:"s"});});
            lkpChm.forEach(function(d){lkpSrch.push({value:d.id, label:d.desc, typ:"c"});});
            lkpFcy.forEach(function(d){lkpSrch.push({value:d.id, label:d.desc, typ:"f"});});
            
            $("#tags").autocomplete({
                                        delay: 25,
                                        minLength: 3,
                                        source: lkpSrch,
                                        focus: function(event, ui) {
                                            $('#tags').val(ui.item.label);
                                            event.preventDefault();
                                        },
                                        select: function(event, ui) {
                                            $('#tags').val(ui.item.label);

                                            if(ui.item.typ === "c") {filterData(null, ui.item.value, null, null);}
                                            if(ui.item.typ === "s") {filterData(ui.item.value, null, null, null);}
                                            if(ui.item.typ === "f") {filterData(null, null, ui.item.value, null);}
                                            return false;
                                    }
                                    
                                    });
        }
        
        var prg = false;
        function showProgress(){
            if(prg === true){return;}
            prg = true;
            $("#progressbarDlg").removeClass("hidden");
            $("#progressbarDlg").dialog({modal:true,
                                        dialogClass:"no-title-bar no-close-button",
                                        height:50});
            $(".ui-dialog-titlebar").removeClass('ui-widget-header');
            //var progressbar = $("#progressbar").progressbar();
            //progressbar.progressbar( "option", "value", false );
            //var progressbarValue = progressbar.find( ".ui-progressbar-value" );
            //progressbarValue.css({
            //                     "background": '#' + Math.floor( Math.random() * 16777215 ).toString( 16 )
            //                     });
            
            
        }
        function hideProgress(){
            $("#progressbarDlg").dialog("close");
            $("#progressbarDlg").addClass("hidden");
            prg = false;
        }
        
        initLkps();
        visualCirc();
        
        // --------------------------------------------------------------------------------------------------------
        var toxin, all, state, staten, chemical, chemicals, facility, facilities;
        var air, water, landf, uground, landt, surf, recvr, recyl, trtmt;
        function main(argv) {

            //showProgress();
            resetAllFilters(false);
            
            if(argv===null)
                argv = "./data/01.json";
            
            toxin = all = state = staten = chemical = chemicals = facility = facilities = null;
            air = water = landf = uground = landt = surf = recvr = recyl = trtmt = null;

            d3.json(argv, function (err, toxins) {

                if(err) {console.log(err); hideProgress();}
                    
                // Create the crossfilter for the relevant dimensions and groups.
                toxin = crossfilter(toxins),
                    all = toxin.groupAll(),
                    state = toxin.dimension(function (d) { return d.s; }),
                    staten = state.group(),
                    chemical = toxin.dimension(function (d) { return d.h; }),
                    chemicals = chemical.group(),
                    facility = toxin.dimension(function (d) { return d.y; }),
                    facilities = facility.group(),
                    air = toxin.dimension(function (d) {return d.a;}),
                    water = toxin.dimension(function (d) {return d.w;}),
                    landf = toxin.dimension(function (d) {return d.f;}),
                    uground = toxin.dimension(function (d) {return d.g;}),
                    landt = toxin.dimension(function (d) {return d.a;}),
                    surf = toxin.dimension(function (d) {return d.u;}),
                    recvr = toxin.dimension(function (d) {return d.v;}),
                    recyl = toxin.dimension(function (d) {return d.e;}),
                    trtmt = toxin.dimension(function (d) {return d.m;});
                
                    visualSankey();
                    visualMap();
                    visualSunburst();
                    
                //hideProgress();
            });
        }

        function stateData(){
            // get carcinogens
            return staten.reduce(
                                     function ra(p, v) {
                                     if(v.c === 1) { p.carc = p.carc + v.t; }
                                     p.t = p.t + v.t;
                                     p.perc = p.t === 0 ? 0 : (p.carc / p.t) * 100;
                                     return p; },
                                     function rr(p, v) {},
                                     function ri() { return {carc:0, t:0, perc:0}; }).top(Infinity);
            
        }
        function chemicalData(){
            // get chemicals
            var chemData = chemicals.reduce(
                                        function ra(p, v) {
                                        p.name = v.h;
                                        p.size = p.size + v.t;
                                        if(v.c === 1) {p.carc = p.carc + v.t;}
                                        p.children.push({name:v.y, size:v.t, carc:v.c === 1? v.t:0});
                                        return p;
                                        },
                                        function rr(p, v) { },
                                        function ri() {
                                        return { name:0, size:0, carc:0, children:[] }; });
            // to flare format
            var chemArray = [];
            chemData.top(Infinity).forEach(function (d) {
                                           chemArray.push({name:d.value.name, size:d.value.size, carc:d.value.carc, children:d.value.children});
                                           });
            return {name:"All", children:chemArray};

        }
        function mediumData(){
            var mediumData = all.reduce(
             function ra(p, v) {
             p.a += v.a; p.w += v.w; p.g += v.g; p.f += v.f; p.r += v.r; p.u += v.u;
             p.v += v.v; p.e += v.e; p.m += v.m;
             return p;
             },
             function rr(p, v) {},
             function ri() {
             return { a: 0, w: 0, g: 0, f: 0, r: 0, u: 0, v: 0, e: 0, m: 0 };
             });
             //console.log(mediumData.value());
             
             var mediumNodes = [];
             mediumNodes.push({ name: "Total Releases" }); //0
             mediumNodes.push({ name: "Air" }); //1
             mediumNodes.push({ name: "Water" }); //2
             mediumNodes.push({ name: "Underground" });  //3
             mediumNodes.push({ name: "Land fills" });  //4
             mediumNodes.push({ name: "Land treatment" }); //5
             mediumNodes.push({ name: "Surface" }); //6
             mediumNodes.push({ name: "Recovery" }); //7
             mediumNodes.push({ name: "Recycle" }); //8
             mediumNodes.push({ name: "Treatment" }); //9
             
             var mediumLinks = [];
             mediumLinks.push({ source: 1, target: 0, value: mediumData.value().a===0 ? 0.1 : mediumData.value().a }); // total <- air
             mediumLinks.push({ source: 2, target: 0, value: mediumData.value().w===0 ? 0.1 : mediumData.value().w }); // total <- water
             mediumLinks.push({ source: 3, target: 0, value: mediumData.value().g===0 ? 0.1 : mediumData.value().g }); // total <- underground
             mediumLinks.push({ source: 4, target: 0, value: mediumData.value().f===0 ? 0.1 : mediumData.value().f }); // total <-
             mediumLinks.push({ source: 5, target: 0, value: mediumData.value().r===0 ? 0.1 : mediumData.value().r }); // total ->
             mediumLinks.push({ source: 6, target: 0, value: mediumData.value().u===0 ? 0.1 : mediumData.value().u }); // total ->
             mediumLinks.push({ source: 0, target: 7, value: mediumData.value().v===0 ? 0.1 : mediumData.value().v }); // total ->
             mediumLinks.push({ source: 0, target: 8, value: mediumData.value().e===0 ? 0.1 : mediumData.value().e }); // total ->
             mediumLinks.push({ source: 0, target: 9, value: mediumData.value().m===0 ? 0.1 : mediumData.value().m }); // total ->
            
            return {nodes:mediumNodes, links:mediumLinks};
        }
        function visualMap(){
            
            // clear stale data
            d3.select("#leftBar").selectAll("svg").remove();
        
                    var data = stateData();
                    var width = 350,//960,
                    height = 225;//500;
            
            var quantize = function(d) {
                if(d < 1000) {
                    return "q0-11";
                }
                if(d >= 1000 && d < 10000) {
                    return "q1-11";
                }
                if(d >= 10000 && d < 50000) {
                    return "q2-11";
                }
                if(d >= 50000 && d < 75000) {
                    return "q3-11";
                }
                if(d >= 75000 && d < 100000) {
                    return "q4-11";
                }
                if(d >= 100000 && d < 250000) {
                    return "q5-11";
                }
                if(d >= 250000 && d < 500000) {
                    return "q6-11";
                }
                if(d >= 500000 && d < 1000000) {
                    return "q8-11";
                }
                if(d >= 1000000 && d < 1500000) {
                    return "q9-11";
                }
                if(d >= 1500000) {
                    return "q10-11";
                }
            }
            
                    /*var quantize = d3.scale.quantize()
                    .domain(d3.extent(data, function(d) {return d.value.t;}))//.domain([0, .15])
                    //.range(function(d,i){console.log(d + "-" + i);})
                    .range(d3.range(10).map(function(d,i) {console.log(d + "-" + i);return "q" + i + "-11";}));
                    //.range(d3.range(12).map(function(i) {return "q" + i + "-9";}));
                    //.range(d3.range(63).map(function(i) {return "q0" + i + "-63";}));
                    //.range(d3.range(9).map(function(i) { return "q0" + i + "-9"; }));*/
                    
                    var path = d3.geo.path();
                    
                    var svg = d3.select("#leftBar").append("svg")
                    .attr("width", width)
                    .attr("height", height);
                  
                    svg.append("g")
                    //.attr("class", "counties")
                    //.attr("class", "RdYlGn1")
                    .attr("class", "GnYlRd")
                    .attr("transform", "scale(0.40) translate(-25, 45)")
                    .selectAll("path")
                    .data(topojson.feature(lkpUS, lkpUS.objects.counties).features)
                    .enter().append("path")
                    .attr("class", function(d) {
                          var t = $.grep(data, function(item){ return d.id === item.key; })[0];
                          if(typeof t === 'undefined'){
                            //console.log("not found-" + d.id);
                            return "q11-11";
                          }
                          var v = quantize(t.value.t);
                          //console.log("found:" + d.id + ":" + v + ":" + t.value.t);
                          return v;})
                    .attr("d", path)
                    .on("click", function click(d){
                        filterData(d.id,null,null,null);})
                    .append("svg:title")
                    .text(function(d){
                          var t = $.grep(data, function(item){ return item.key === d.id; })[0];
                          var l = $.grep(lkpSt, function(item){ return item.f === d.id; })[0];
                          
                          var cstip = "";
                          if(typeof l !== 'undefined') {
                            cstip = "County:" + l.c + "\nState:" + l.s;
                          }
                          if(typeof t === 'undefined'){
                            cstip = "No data available.\n" + cstip + "\nzipCode:" + d.id;
                          }
                          else {
                            cstip = "Total Releases:" + humanReadable(t.value.t) + "\n" + cstip;
                          }
                          
                          return cstip;
                          
                        });;
                    
                    //svg.append("path")
                    //.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                    //.attr("class", "states")
                    //.attr("transform", "scale(0.4) translate(-25, 45)")
                    //.attr("d", path);
                    
                    
                    //
                    var th = "Facility County";
                    var tsize = calcDummyTitle(th, "heading");
                    
                    svg.append("svg:text")
                    .attr("x", width/2)
                    .attr("y", tsize.height/2 + 15)
                    .attr("class", "heading")
                    .text(th)
                    .on("click", function(d){
                        showHelp(2);
                        });


           
        }
 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////

    function visualSankey() {
        
        // clear stale data
        d3.select("#sub-footer").selectAll("svg").remove();
        
        var margin = {top: 10, right: 1, bottom: 1, left: 50},
            width = /*960*/700 - margin.left - margin.right,
            height = /*500*/150 - margin.top - margin.bottom;

        //var formatNumber = d3.format(",.0f"),
        //format = function (d) { return formatNumber(d) + "M"; };
        //color = d3.scale.category20();

        var svg = d3.select("#sub-footer").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("class", "GnYlRd")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var sankey = d3.sankey()
            .nodeWidth(15)
            .nodePadding(25)
            .size([width, height-5]);

        var path = sankey.link();

        var m = mediumData();
        sankey
            .nodes(m.nodes)
            .links(m.links)
            .layout(32);

        var link = svg.append("g").selectAll(".link")
            .data(m.links)
        .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .style("stroke-width", function (d) {
                   return Math.max(1, d.dy); })
        .on("mousedown", function (d, i ){
            var m = 1;
            if(d.source.name==="Air") m=1;
            if(d.source.name==="Water") m=2;
            if(d.source.name==="Underground") m=3;
            if(d.source.name==="Land fills") m=4;
            if(d.source.name==="Land treatment") m=5;
            if(d.source.name==="Surface") m=6;
            if(d.target.name==="Recovery") m=7;
            if(d.target.name==="Recycle") m=8;
            if(d.target.name==="Treatment") m=9;
      
            
            filterData(null, null, null, m);
            
            })
        .sort(function (a, b) {
                   return b.dy - a.dy; });

        link.append("title")
            .text(function (d) {
            //return d.source.name + " ? " + d.target.name + "\n" + format(d.value); });
            return d.source.name + ":" + d.target.name + "\n" + humanReadable(d.value); });
            var node = svg.append("g").selectAll(".node")
        .data(m.nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) {
                  return "translate(" + d.x + "," + d.y + ")";
                  })
        .call(d3.behavior.drag()
            .origin(function (d) { return d; })
    
        .on("dragstart", function () { this.parentNode.appendChild(this); })
        .on("drag", dragmove));
    
        node.append("rect")
            .attr("height", function (d) {
                  return d.dy; })
            .attr("width", sankey.nodeWidth())
            //.style("fill", function (d) {
            //      return d.color = color(d.name.replace(/ .*/, "")); })
            .attr("class", function (d) {
                  return "q" + Math.min(8, ~ ~(d.value / 120000)) + "-11";
                  })
            .style("stroke", function (d) {
                    return d3.rgb(d.color).darker(2);
                   })
            .append("title")
            .text(function (d) {
                    return d.name + "\n" + humanReadable(d.value);
                  });

        node.append("text")
            .attr("x", -6)
            .attr("y", function(d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function (d) {
                    return d.name;
                  })
            .filter(function (d) {
                    return d.x < width / 2;
                  })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");

        //
        var th = "Medium of Release";
        var tsize = calcDummyTitle(th, "heading");
        
        svg.append("svg:text")
            .attr("x", width/2)
            .attr("y", tsize.height/2)
            .attr("class", "heading")
            .style("text-anchor", "middle")
            .text(th)
        .on("click", function(d){
            showHelp(1);
            });

        
        
        
        function dragmove(d) {
                d3.select(this).attr("transform",
                                     "translate(" + (
                                                     d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))
                                                     ) + "," + (
                                                                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
                                                                ) + ")");
                sankey.relayout();
                link.attr("d", path);
            }


        }
        
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function visualSunburst() {
         
            var data = chemicalData();
            var w = 300,//960,
            h = 225, //700,
            r = Math.min(w, h) / 2,
            x = d3.scale.linear().range([0, 2 * Math.PI]),
            y = d3.scale.sqrt().range([0, r]);

            
            // color scale
            //var quantize = d3.scale.quantize()
            //.domain(d3.extent(data.children, function(d) {return d.size;}))
            //.range(d3.range(10).map(function(i) {return "q" + i + "-11";}));

            var quantize = function(d) {
                if(d < 1000) {
                    return "q0-11";
                }
                if(d >= 1000 && d < 100000) {
                    return "q1-11";
                }
                if(d >= 100000 && d < 500000) {
                    return "q2-11";
                }
                if(d >= 500000 && d < 1000000) {
                    return "q3-11";
                }
                if(d >= 1000000 && d < 10000000) {
                    return "q4-11";
                }
                if(d >= 10000000 && d < 100000000) {
                    return "q5-11";
                }
                if(d >= 100000000 && d < 500000000) {
                    return "q6-11";
                }
                if(d >= 500000000 && d < 1000000000) {
                    return "q8-11";
                }
                if(d >= 1000000000 && d < 5000000000) {
                    return "q9-11";
                }
                if(d >= 5000000000) {
                    return "q10-11";
                }
            }
            
            // clear stale data
            d3.select("#rightBar").selectAll("svg").remove();
            
            var svg = d3.select("#rightBar").append("svg:svg")
                .attr("width", w)
                .attr("height", h);
            
            var th = "Toxins at Facilities";
            var tsize = calcDummyTitle(th, "heading");
             
            var gt = svg.append("svg:g")
             .append("svg:text")
             .attr("x", w/2 - 15)
             .attr("y", tsize.height/2 + 15)
             .attr("class", "heading")
             .text(th)
            .on("click", function(d){
                showHelp(3);
                });

            var g = svg.append("svg:g")
                .attr("class", "GnYlRd")
                .attr("transform", "scale(0.8) translate(" + 160 + "," + 160 + ")");
            
            var partition = d3.layout.partition()
                .value(function(d) { return d.size; });
            
            var arc = d3.svg.arc()
                .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
                .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
                .innerRadius(function(d) { return Math.max(0, y(d.y)); })
                .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

            //var path = vis.data([chemicalData()]).selectAll("path")
            var path = g.selectAll("path")
                .data(partition.nodes(data))
                .enter().append("path")
                .attr("d", arc)
                .attr("class", function (d) {
                      if(d.name==="All"){
                        return "q11-11";
                      }
                      return quantize(d.value);
                      //return "q" + Math.min(8, ~ ~(d.value / 1200000000)) + "-9";
                      //if(d.carc)
                      //  return "q" + Math.min(8, ~ ~((d.carc * 100/d.size) * 9 / 12)) + "-9";
                      //else
                      //  return "q8-9";
                      
                      })
            .on("mouseover", function(d,i){
                d3.select(this)
                .style("stroke", function(d){
                       return d3.rgb(d3.select(this).style("stroke")).darker(7);
                       })
                .style("stroke-width", "2")
                .style("opacity", ".5");
                })
            .on("mouseout", function(d,i){
                d3.select(this)
                .style("stroke", function(d){
                       return d3.rgb(d3.select(this).style("stroke")).brighter(7);
                       })
                .style("stroke-width", "1")
                .style("opacity", "1");
                })
            .on("click", click)
            .append("svg:title")
                .text(function(d,i){
                      var stip = "releases";
                      if(d.depth===0)
                            stip = d.name + "\n" + humanReadable(d.value);
                      if(d.depth===1){
                            var sd = $.grep(lkpChm, function(item){return item.id === d.name;})[0];
                            if(typeof sd !== "undefined"){
                                stip = sd.desc + "\nTotal releases:" + humanReadable(d.value) +
                                "\nCarcinogenic:" + (d.carc > 0 ? "Yes" : "No");
                            }
                      }
                      if(d.depth===2){
                            stip = lkpFcy[d.name].desc + "\nTotal releases:" + humanReadable(d.value) +
                            "\nCarcinogen:" + (d.carc > 0 ? "Yes" : "No");
                      
                            //var sd = $.grep(lkpFcy, function(item){return item.id === d.name;})[0];
                            //if(typeof sd !== "undefined") {
                            //    stip = sd.desc + "\nTotal releases:" + humanReadable(d.value) +
                            //    "\nCarcinogen:" + (d.carc > 0 ? "Yes" : "No");
                            //}
                      }
                      return stip;
            });
        
            
            
            function click(d){
                //path.transition().duration(750).attrTween("d", arcTween);
                if(d.depth===1){filterData(null,d.name,null,null);}
                if(d.depth===2){filterData(null,null,d.name,null);}
            }
        
            /*function arcTween(d) {
                var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                yd = d3.interpolate(y.domain(), [d.y, 1]),
                yr = d3.interpolate(y.range(), [d.y ? 20 : 0, r]);
                return function(d, i) {
                        return i
                        ? function(t) { return arc(d); }
                        : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
                    };
            }*/
            
        }

        function visualCirc(){
            
            d3.json("./data/lkpYr.json", function (lkpYr) {
                    
            var w = 750;
            var h = 75;
            var barPadding = 1;
 
            // clear stale data
            d3.select("#footer").selectAll("svg").remove();
            
            //Create scale functions
            var horz = d3.scale.linear()
            .domain([0, d3.max(lkpYr, function (d) { return d.y; })])
            .range([0, w]);
            
            // color scale
            var quantize = d3.scale.quantize()
                .domain(d3.extent(lkpYr, function(d) {return d.gtotal;}))
                .range(d3.range(10).map(function(i) {return "q" + i + "-11";}));
            
            //Create SVG element
            var svg = d3.select("#footer")
            .append("svg:svg")
            .attr("width", w)
            .attr("height", h)
            .append("svg:g")
            .attr("class", "GnYlRd");
            
            var node = svg.selectAll("circle")
            .data(lkpYr)
            .enter()
              .append("svg:circle")
            .attr("cx", function(d,i){
                  return Math.round(horz(i)) + Math.round((w / lkpYr.length - barPadding))/2;
                  })
            .attr("r", Math.round((w / lkpYr.length - barPadding))/2)
            .attr("cy", Math.round((w / lkpYr.length - barPadding))/2 + 40)
            .attr("class", function (d, i) {
                  var v = quantize(d.gtotal);
                  //console.log(v + ":" + d.gtotal);
                  return v;
                  //return "q" + Math.min(8, ~ ~(d.gtotal * 9 / 12000000000)) + "-9";
                  })
            .style("cursor", "pointer")
            .on("mouseover", function(d,i){
                d3.select(this)
                //.style("stroke", d3.rgb(255).darker(7))
                .style("stroke", function(d){
                       return d3.rgb(d3.select(this).style("stroke")).darker(7);
                       })
                .style("stroke-width", "1")
                .style("opacity", ".2");
                })
            .on("mouseout", function(d,i){
                d3.select(this)
                .style("stroke", function(d){
                       return d3.rgb(d3.select(this).style("stroke")).brighter(7);
                       })
                //.style("stroke", d3.rgb(255).darker(0))
                .style("stroke-width", "0")
                .style("opacity", "1");
                })
            .on("click", function click(d, i){
                var y = i + 1987;
                $("#yearFilterText").text("Current Year:" + y);
                var str = "" + d.y;
                var pad = "00";
                var arg = "./data/" + pad.substring(0, pad.length - str.length) + str + ".json";
                main(arg);
                })
            
            .append("svg:title")
                .text(function(d, i){
                  var y = i + 1987;
                  return "Year:" + y + "\nTotal Releases:" + humanReadable(d.gtotal) +
                      "\nCarcinogen Releases:" + humanReadable(d.ctotal) +
                      "\nCarcinogen Percent:" + formatPerc(d.ctotal/d.gtotal);
                      });
            
            svg.selectAll("g")
                .data(lkpYr)
                .enter()
            .append("svg:text")
            .attr("dx", function(d,i){
                  var dx = Math.round(horz(i)) + Math.round((w / lkpYr.length - barPadding))/2;
                  return dx - 7;
                  })
            .attr("dy", function(d,i){
                  var dy = Math.round((w / lkpYr.length - barPadding))/2 + 40;
                  return dy + 5;
                  })
            .text(function(d, i){
                  return (i + 1987).toString().substring(2,4);
                  })
            .on("click", function click(d, i){
                        var y = i + 1987;
                        $("#yearFilterText").text("Current Year:" + y);
                        var str = "" + d.y;
                        var pad = "00";
                        var arg = "./data/" + pad.substring(0, pad.length - str.length) + str + ".json";
                        main(arg);
                        });
            
            //
            var th = "Over the Years";
            var tsize = calcDummyTitle(th, "heading");
            svg.selectAll("svg")
                .data([th])
                .enter()
                .append("svg:text")
                    .attr("x", w/2)
                    .attr("y", tsize.height/2 + 15)
                    .attr("class", "heading")
                    .style("font-size", "15pt") // specify explicitly even though css has logic
                    .style("text-anchor", "middle")

                .text(th)
            .on("click", function(d){
                showHelp(0);
                })
            .on("mouseover", function(d){
                d3.select(this)
                .style("text-decoration", "underline");
                });
            
            
                    });

            
            
        }

////////////////////////////////////////////////////
        function filterData(st, chm, fcy, med){

            if(chm!=null){
                var stip = chm;
                var sd = $.grep(lkpChm, function(item){return item.id === chm;})[0];
                if(typeof sd !== "undefined"){
                    stip = sd.desc;
                }
                $("#sunburstFilterText").text(stip);
                $("#sunburstFilterLink").attr("href", "javascript:resetFilter(null,1,null,null)")
                chemical.filterExact(chm);
                visualMap();
                visualSankey();
            }
            if(fcy!=null){
                var stip = fcy;
                var sd = $.grep(lkpFcy, function(item){ return item.id === fcy; })[0];
                if(typeof sd !== "undefined") {
                    stip = sd.desc;
                }
                $("#sunburstFilterText").text(stip);
                $("#sunburstFilterLink").attr("href", "javascript:resetFilter(null,null,1,null)")
                facility.filterExact(fcy);
                visualMap();
                visualSankey();
            }
            if(st!=null){
                var stip = st;
                var sd = $.grep(lkpSt, function(item){ return item.f === st; })[0];
                if(typeof sd !== "undefined") {
                    stip = sd.c + "," + sd.s;
                }
                $("#mapFilterText").text(stip);
                state.filterExact(st);
                visualSunburst();
                visualSankey();
            }

            if(med!=null){
                if(med===1){air.filter([1, Infinity]);$("#mediumFilterText").text("Air");};
                if(med===2){water.filter([1, Infinity]);$("#mediumFilterText").text("Water");};
                if(med===3){uground.filter([1, Infinity]);$("#mediumFilterText").text("Underground");};
                if(med===4){landf.filter([1, Infinity]);$("#mediumFilterText").text("Land fills");};
                if(med===5){landt.filter([1, Infinity]);$("#mediumFilterText").text("Land treatment");};
                if(med===6){surf.filter([1, Infinity]);$("#mediumFilterText").text("Surface");};
                if(med===7){recvr.filter([1, Infinity]);$("#mediumFilterText").text("Recovery");};
                if(med===8){recyl.filter([1, Infinity]);$("#mediumFilterText").text("Recycle");};
                if(med===9){trtmt.filter([1, Infinity]);$("#mediumFilterText").text("Treatment");};
                visualMap();
                visualSunburst();
            
            }

        }
////////////////////////////////////////////////////////
        var noneText = "None";
        function resetFilter(st, chm, fcy, med){
            
            if(chm!=null){
                $("#sunburstFilterText").text(noneText);
                chemical.filter(null);
                visualMap();
                visualSankey();
            }
            if(fcy!=null){
                $("#sunburstFilterText").text(noneText);
                facility.filter(null);
                visualMap();
                visualSankey();
            }
            
            if(st!=null){
                $("#mapFilterText").text(noneText);
                state.filter(null);
                visualSunburst();
                visualSankey();
            }
            
            if(med!=null){
                var src = $("#mediumFilterText").text();
                if(src==="Air") {air.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Water") {water.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Underground") {uground.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Land fills") {landf.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Land treatment") {landt.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Surface") {surf.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Recovery") {recvr.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Recycle") {recyl.filter(null);$("#mediumFilterText").text(noneText);};
                if(src==="Treatment") {trtmt.filter(null);$("#mediumFilterText").text(noneText);};
                visualMap();
                visualSunburst();
                
            }
        }
/////////////////////////////////////////////////////////
        function resetAllFilters(redrawDisplay){
            
            // reset status
            $("#sunburstFilterText").text(noneText);
            $("#mapFilterText").text(noneText);
            $("#mediumFilterText").text(noneText);

                        
            if(redrawDisplay === true) {
                
                // reset crossfilter
                chemical.filter(null);
                facility.filter(null);
                state.filter(null);
                air.filter(null);
                water.filter(null);
                uground.filter(null);
                landf.filter(null);
                landt.filter(null);
                surf.filter(null);
                recvr.filter(null);
                recyl.filter(null);
                trtmt.filter(null);

                // redraw displays
                visualMap();
                visualSunburst();
                visualSankey();
            }
        }
        
    </script>
</body>
</html>
